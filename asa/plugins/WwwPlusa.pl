use HTTP::Request::Common qw(POST);
use LWP::UserAgent;
use HTTP::Response;
use Unicode::Lite;
use strict;

my $PLUGIN_NAME			= "WwwPlusa";
my $PLUGIN_VERSION		= "0.2-20051005-kg";
my $DEFAULT_PRIO		= 1;
my $DEST_NUMBERS_REGEXP		= '^\+48(6[069][13579])'; # needed linke this in //

# RULES:
# 1. ALWAYS, ALWAYS, ALWAYS create new presence/message/iq
# 2. Create handlers, plugin is named ser.vi.ce/Plugin
# 3. Provide ALL needed info in %plugin_data

$plugin_data{$PLUGIN_NAME}->{inmessage_h}=\&WwwPlusa_InMessage;
$plugin_data{$PLUGIN_NAME}->{will_take_h}=\&WwwPlusa_WillTake;
$plugin_data{$PLUGIN_NAME}->{default_prio}=$DEFAULT_PRIO;
$plugin_data{$PLUGIN_NAME}->{version}=$PLUGIN_VERSION;
$plugin_data{$PLUGIN_NAME}->{needs_reg}=0;

sub WwwPlusa_WillTake {
	my $from=shift;
	my $to_nr=shift; # if not provided, it means it asks for the service, w/o number served by it 
	return ($to_nr?($to_nr =~ /$DEST_NUMBERS_REGEXP/):1);
};

sub WwwPlusa_InMessage {
	my $message_o=shift;
	my $type=shift;
	my $to=$message_o->GetTo(); my $from=$message_o->GetFrom();
	my $message=new Net::Jabber::Message;
	$message->SetTo($from); $message->SetFrom($to); $message->SetType($type);
	my $SN=$config{service_name};
	my $PN=$SN."/".$PLUGIN_NAME;
	my $base_from=$from; $base_from=~s/\/.+$//g if ($base_from =~ /\//);
	my $nr=$to; $nr=~s/@.+$//g;
	return unless ($to =~ /$PN$/); # shouldn't happen

	# the guts:
	
	my $tprefix=$nr; $tprefix=~s/^\+48//g; $tprefix=~s/[0-9]{6}$//g;
	my $numer=$nr; $numer=~s/^\+48[0-9]{3}//g;
	my $podpis=$base_from; $podpis=~s/@.+$//g;
	my $tekst=convert("utf8","latin2",$message_o->GetBody());
	my $ua=LWP::UserAgent->new;
	$ua->agent("Mozilla/3.0 (X11; I; Linux 2.2.9 i686)");
	$ua->timeout(30);
	my $prox=WwwPlusa_GenerateProxy();
	$ua->proxy('http',"http://$prox/");
	my $r=$ua->post("http://www.text.plusgsm.pl/sms/sendsms.php",
		[tprefix=>$tprefix,numer=>$numer,odkogo=>$podpis,tekst=>$tekst]);
	if ($r->is_success) {
		my $t=(grep(/<BR>/,split(/\n/,$r->content)))[0];
		$t=~s/<[^>]+>//g; $t=~s/\&nbsp;/ /g; $t=~s/\s+/ /g; $t=~s/^ //g;
		$message->SetBody("www.text.plusgsm.pl /proxy:$prox/: ".convert("latin2","utf8",$t));
	} else {
		log4($PLUGIN_NAME.": using proxy $prox failed");
		$message->SetBody("/proxy:$prox/ Error posting data to www.text.plusgsm.pl");
	};	
	$Connection->Send($message);
};

my $WwwPlusa_lastproxy=0;
my @WwwPlusa_proxies=qw(
125.214.233.68:8080
128.10.19.52:3127
128.10.19.52:3128
128.112.139.108:3124
128.112.139.108:3127
128.112.139.108:3128
128.112.139.73:3124
128.112.139.73:3127
128.112.139.73:3128
128.112.139.74:3124
128.112.139.74:3128
128.112.139.75:3124
128.112.139.75:3127
128.112.139.75:3128
128.112.139.78:3124
128.112.139.78:3127
128.112.139.78:3128
128.112.139.80:3124
128.112.139.80:3127
128.112.139.80:3128
128.112.139.96:3124
128.112.139.96:3127
128.112.139.97:3124
128.112.139.97:3128
128.112.139.97:8888
128.114.63.15:3128
128.114.63.16:3124
128.114.63.16:3127
128.114.63.16:3128
128.119.247.210:3124
128.119.247.210:3127
128.119.247.210:3128
128.119.247.211:3128
128.135.11.149:3128
128.135.11.151:3128
128.135.11.152:3128
128.143.137.249:3127
128.143.137.249:3128
128.143.137.250:3128
128.163.142.20:3128
128.163.142.21:3128
128.192.101.217:3127
128.192.101.217:3128
128.192.101.218:3124
128.193.33.8:3128
128.195.25.100:3124
128.195.25.100:3128
128.195.25.102:3124
128.195.25.102:3128
128.197.13.31:3127
128.197.13.31:3128
128.208.4.197:3127
128.208.4.197:3128
128.208.4.199:3127
128.208.4.199:3128
128.214.112.91:3128
128.214.112.92:3124
128.214.112.92:3127
128.214.112.92:3128
128.220.247.28:3124
128.220.247.28:3127
128.220.247.28:3128
128.220.247.29:3127
128.220.247.29:3128
128.223.6.111:3124
128.223.6.111:3127
128.223.6.111:3128
128.223.6.112:3124
128.223.6.112:3127
128.223.6.112:3128
128.223.6.113:3124
128.223.6.113:3127
128.223.6.113:3128
128.232.103.202:3124
128.232.103.202:3127
128.232.103.202:3128
128.232.103.203:3127
128.232.103.203:3128
128.238.88.64:3124
128.238.88.64:3127
128.238.88.64:3128
128.238.88.65:3124
128.238.88.65:3127
128.238.88.65:3128
128.252.19.20:3124
128.252.19.20:3127
128.252.19.20:3128
128.252.19.21:3124
128.252.19.21:3127
128.252.19.21:3128
128.31.1.11:3124
128.31.1.11:3128
128.31.1.12:3124
128.31.1.12:3128
128.31.1.13:3124
128.31.1.13:3128
128.31.1.14:3124
128.31.1.14:3128
128.31.1.15:3124
128.31.1.15:3128
128.31.1.15:8888
128.31.1.16:3124
128.31.1.16:3128
128.4.36.11:3124
128.4.36.11:3127
128.4.36.11:3128
128.4.36.12:3124
128.4.36.12:3127
128.4.36.12:3128
128.8.126.111:3124
128.8.126.111:3127
128.8.126.111:3128
128.8.126.112:3124
128.8.126.112:3127
128.8.126.112:3128
128.8.126.69:3127
128.8.126.69:3128
129.10.120.111:3124
129.10.120.111:3127
129.10.120.111:3128
129.10.120.112:3124
129.10.120.112:3127
129.10.120.112:3128
129.105.44.253:3124
129.105.44.253:3127
129.105.44.253:3128
129.108.202.10:3124
129.108.202.10:3127
129.108.202.10:3128
129.12.3.74:3124
129.12.3.74:3127
129.12.3.74:3128
129.12.3.75:3124
129.12.3.75:3127
129.12.3.75:3128
129.137.253.253:3124
129.137.253.253:3127
129.137.253.253:3128
129.170.214.191:3124
129.170.214.191:3127
129.170.214.191:3128
129.170.214.191:8888
129.170.214.192:3124
129.170.214.192:3127
129.170.214.192:3128
129.174.58.172:3128
129.186.205.76:3124
129.186.205.76:3128
129.186.205.77:3124
129.186.205.77:3128
129.22.150.105:3124
129.22.150.105:3127
129.22.150.105:3128
129.22.150.90:3124
129.22.150.90:3127
129.22.150.90:3128
129.237.123.250:3128
129.237.123.251:3128
129.24.17.69:3128
129.24.17.70:3128
129.242.19.196:3127
129.242.19.196:3128
129.242.19.197:3124
129.242.19.197:3127
129.242.19.197:3128
129.74.152.67:3127
129.74.152.67:3128
129.82.12.187:3124
129.82.12.187:3127
129.82.12.187:3128
129.82.12.188:3124
129.82.12.188:3127
129.82.12.188:3128
129.93.68.55:3124
129.93.68.55:3127
129.93.68.55:3128
130.104.72.200:3124
130.104.72.201:3124
130.136.254.22:3127
130.136.254.22:3128
130.149.49.28:3128
130.161.40.153:3124
130.161.40.154:3128
130.192.201.30:3128
130.37.198.243:3124
130.37.198.243:3127
130.37.198.243:3128
130.49.221.41:3124
130.49.221.41:3127
130.49.221.41:3128
130.75.87.84:3124
130.83.160.199:3124
130.83.160.199:3127
130.83.160.199:3128
130.83.160.200:3127
130.83.160.200:3128
130.88.203.26:3124
130.88.203.26:3128
130.88.203.27:3124
130.88.203.27:3128
130.92.70.251:3124
130.92.70.251:3127
130.92.70.251:3128
130.92.70.252:3124
130.92.70.252:3127
130.92.70.252:3128
131.175.17.10:3128
131.179.112.70:3124
131.179.112.70:3127
131.179.112.70:3128
131.179.112.70:8888
131.179.112.71:3124
131.179.112.71:3127
131.179.112.71:3128
131.188.44.100:3124
131.188.44.100:3127
131.188.44.100:3128
131.246.191.42:3124
131.246.191.42:3127
131.246.191.42:3128
132.187.230.2:3127
132.187.230.2:3128
132.204.102.20:3124
132.204.102.20:3127
132.204.102.20:3128
132.204.102.22:3124
132.204.102.22:3127
132.204.102.22:3128
132.252.152.193:3124
132.252.152.193:3127
132.252.152.193:3128
132.252.152.194:3128
133.11.240.56:3127
133.11.240.56:3128
133.11.240.57:3124
133.11.240.57:3128
134.2.202.228:3124
134.2.202.228:3127
136.145.115.194:3127
136.145.115.194:3128
137.99.11.86:3124
137.99.11.86:3128
137.99.11.87:3127
137.99.11.87:3128
138.23.204.133:3124
138.23.204.133:3127
138.23.204.133:3128
138.23.204.232:3124
138.23.204.232:3127
138.23.204.232:3128
139.19.142.2:3124
139.19.142.2:3127
139.19.142.2:3128
139.19.142.3:3124
139.19.142.3:3127
139.19.142.3:3128
139.19.142.4:3124
139.19.142.4:3127
139.19.142.4:3128
139.19.142.5:3127
139.19.142.5:3128
139.19.142.6:3124
139.19.142.6:3127
139.19.142.6:3128
140.109.17.180:3124
140.109.17.180:3127
140.109.17.180:3128
140.109.17.181:3124
140.109.17.181:3127
140.109.17.181:3128
140.114.79.231:3127
140.114.79.231:3128
140.192.37.134:3128
140.247.60.123:3124
140.247.60.123:3128
140.247.60.126:3124
140.247.60.126:3127
140.247.60.126:3128
141.149.218.209:3128
141.213.4.201:3127
141.213.4.201:3128
141.213.4.202:3124
141.213.4.202:3127
141.213.4.202:3128
141.217.48.51:3124
141.217.48.51:3127
141.217.48.51:3128
141.24.33.162:3127
141.24.33.162:3128
142.103.2.1:3124
142.103.2.1:3127
142.103.2.1:3128
142.103.2.2:3124
142.103.2.2:3127
142.103.2.2:3128
142.150.3.246:3128
142.150.3.247:3128
143.107.111.194:3124
143.248.139.169:3124
143.248.139.170:3124
144.216.2.52:3128
147.102.3.101:3128
147.102.3.102:3128
147.83.118.109:3128
147.83.118.125:3128
150.165.15.19:3124
150.165.15.19:3128
152.3.138.1:3128
152.3.138.2:3128
152.3.138.3:3128
153.19.251.230:8080
155.98.35.3:3124
155.98.35.3:3127
155.98.35.3:3128
155.98.35.4:3128
156.17.10.52:3128
156.56.103.61:3124
156.56.103.61:3127
156.56.103.61:3128
156.56.103.62:3124
156.56.103.62:3127
156.56.103.62:3128
158.130.6.253:8888
158.130.6.254:3124
158.130.6.254:3127
158.130.6.254:3128
160.36.57.172:3124
160.36.57.172:3127
160.36.57.172:3128
160.36.57.173:3124
160.36.57.173:3127
160.36.57.173:3128
163.221.11.71:3128
163.221.11.72:3124
163.221.11.72:3127
163.221.11.72:3128
163.221.11.73:3124
163.221.11.73:3127
163.221.11.73:3128
164.107.127.12:3124
164.107.127.12:3127
164.107.127.12:3128
164.107.127.13:3128
165.91.83.22:3124
165.91.83.22:3127
165.91.83.22:3128
165.91.83.23:3124
165.91.83.23:3127
165.91.83.23:3128
169.229.50.10:3127
169.229.50.10:3128
169.229.50.11:3127
169.229.50.11:3128
169.229.50.13:3128
169.229.50.14:3128
169.229.50.15:3124
169.229.50.15:3128
169.229.50.15:8888
169.229.50.17:3124
169.229.50.17:3127
169.229.50.17:3128
169.229.50.18:3124
169.229.50.18:3127
169.229.50.18:3128
169.229.50.3:3124
169.229.50.3:3127
169.229.50.3:3128
169.229.50.6:3124
169.229.50.6:3127
169.229.50.6:3128
169.229.50.8:3124
169.229.50.8:3127
169.229.50.8:3128
169.229.50.9:3124
169.229.50.9:3127
169.229.50.9:3128
171.66.3.181:3124
171.66.3.181:3127
171.66.3.181:3128
192.17.239.250:3124
192.17.239.250:3128
192.17.239.251:3128
192.17.239.252:3128
192.17.239.253:3124
192.170.103.21:3128
192.197.121.3:3124
192.197.121.3:3128
192.33.210.16:3124
192.33.210.16:3127
192.33.210.16:3128
192.33.210.17:3124
192.33.210.17:3127
192.33.210.17:3128
192.33.90.195:3124
192.33.90.195:3127
192.33.90.195:3128
192.33.90.196:3127
192.33.90.196:3128
192.33.90.197:3124
192.33.90.197:3127
192.33.90.197:3128
192.38.109.143:3124
192.38.109.143:3127
192.38.109.143:3128
192.38.109.144:3124
192.38.109.144:3127
192.38.109.144:3128
192.41.135.218:3124
192.41.135.218:3128
192.41.135.219:3128
193.1.201.27:3128
193.136.191.25:3124
193.136.191.25:3127
193.136.191.25:3128
193.136.191.26:3124
193.136.191.26:3127
193.136.191.26:3128
193.144.21.130:3128
193.167.182.130:3124
193.167.182.130:3127
193.167.182.130:3128
193.174.67.187:3124
193.174.67.187:3127
193.174.67.187:3128
193.219.28.144:8080
193.219.28.146:8080
193.6.20.4:3127
193.63.58.70:3128
193.63.58.71:3128
194.29.178.6:3124
194.29.178.6:3127
194.29.178.6:3128
194.36.10.154:3124
194.36.10.154:3127
194.36.10.154:3128
194.36.10.156:3127
194.36.10.156:3128
194.42.17.123:3124
194.42.17.123:3127
194.42.17.123:3128
194.80.38.242:3124
194.80.38.242:3127
194.80.38.242:3128
194.80.38.243:3124
194.80.38.243:3127
194.80.38.243:3128
195.116.60.34:3127
195.116.60.34:3128
195.116.60.65:3124
195.116.60.65:3127
195.116.60.65:3128
195.116.60.82:3124
195.116.60.82:3127
195.116.60.82:3128
195.116.60.83:3124
195.116.60.83:3127
195.116.60.83:3128
195.37.16.101:3124
195.37.16.101:3127
195.37.16.101:3128
198.163.152.229:3124
198.163.152.229:3127
198.163.152.229:3128
198.163.152.230:3128
198.7.255.162:3124
198.7.255.162:3127
198.7.255.162:3128
198.7.255.163:3127
198.7.255.163:3128
199.77.128.194:3124
199.77.128.194:3128
200.129.0.162:3124
200.129.0.162:3127
200.129.0.162:3128
200.132.0.70:3124
200.132.0.70:3127
200.132.0.70:3128
200.166.55.208:3128
200.42.223.196:8080
201.81.227.185:3128
202.101.6.85:8080
202.106.192.130:8080
202.181.243.197:8080
202.189.126.86:3128
202.194.210.9:3128
202.249.37.211:3128
202.249.37.212:3127
202.249.37.212:3128
205.189.33.178:3128
206.117.37.4:3128
206.117.37.5:3124
206.117.37.5:3127
206.117.37.5:3128
206.12.16.133:3128
206.12.16.134:3127
206.12.16.134:3128
206.207.248.34:3124
206.207.248.34:3128
206.207.248.35:3124
206.207.248.35:3128
206.207.248.35:8888
210.107.249.51:3124
210.107.249.51:3128
210.125.84.15:3128
210.125.84.16:3124
210.125.84.16:3127
210.125.84.16:3128
210.75.106.113:8080
211.170.204.237:3128
211.35.133.242:8080
212.201.44.74:3124
212.201.44.74:3127
212.201.44.74:3128
213.189.16.178:8080
216.165.109.79:3127
216.165.109.79:3128
216.165.109.81:3124
216.165.109.81:3127
216.165.109.81:3128
216.165.109.82:3128
217.98.20.195:8080
217.98.20.20:8080
218.181.120.53:8080
218.98.195.20:553
218.98.195.20:554
219.138.199.178:8080
35.9.27.26:3124
35.9.27.26:3127
35.9.27.26:3128
35.9.27.27:3127
35.9.27.27:3128
58.225.128.88:50050
58.67.31.194:80
59.157.190.21:8080
61.185.219.235:80
65.64.31.217:8000
69.110.237.115:3128
69.110.237.116:3127
69.110.237.116:3128
8.8.36.69:80
);

sub WwwPlusa_GenerateProxy {
	$WwwPlusa_lastproxy+=1;
	$WwwPlusa_lastproxy%=$#WwwPlusa_proxies+1;
	return $WwwPlusa_proxies[$WwwPlusa_lastproxy];
};

1;

